<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spotify Now Playing ‚Äî Animated Lyrics</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Nunito:wght@300;700&display=swap" rel="stylesheet">
<style>
    /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ */
    :root{
        --main-white: #ffffff;
        --muted: rgba(255,255,255,0.22);
    }
    html,body{
        height:100%;
        margin:0;
        background:#000;
        color:var(--main-white);
        font-family:'Nunito', sans-serif;
        overflow:hidden;
    }

    #blur-bg {
        position: fixed;
        inset: 0;
        background-size: cover;
        background-position: center;
        filter: blur(38px) brightness(0.36);
        z-index: 0;
        transform: scale(1.15);
        transition: background-image .45s ease;
    }

    #bottom-container {
        position: fixed;
        bottom: 20px;
        left: 0;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        z-index: 10;
        padding: 0 20px;
        box-sizing: border-box;
    }

    #vinyl-container {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: radial-gradient(#111 0%, #000 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
    }
    #albumImage{
        width: 70%;
        height: 70%;
        border-radius: 50%;
        object-fit: cover;
        transition: opacity .36s ease;
    }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .spinning{ animation:spin 12s linear infinite; }
    .paused{ animation-play-state: paused; }

    #now-playing-text {
        font-family: 'Nunito', sans-serif;
        font-weight: 700;
        font-size: 16px;
        color: var(--main-white);
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #now-playing-track {
        font-weight: 800;
        margin-bottom: 4px;
    }
    #now-playing-artist {
        font-weight: 600;
        opacity: 0.8;
        font-size: 14px;
    }

    #lyric-wrapper{
        position:absolute;
        inset: 0;
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:5;
        pointer-events:none;
        padding-bottom: 120px;
    }

    #lyric-line {
        font-family: 'Montserrat', sans-serif;
        font-weight:800;
        font-size: clamp(28px, 6vmin, 72px);
        color: var(--main-white);
        opacity: 0;
        white-space: nowrap;
        transform-origin: center;
        text-align:center;
        padding: 8px 18px;
        line-height:1;
        letter-spacing: .6px;
        text-shadow: 0 0 20px rgba(255,255,255,0.18), 0 10px 30px rgba(0,0,0,0.6);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ */
    @keyframes fadeZoomIn {
        0% { opacity:0; transform: scale(1.22); filter: blur(6px); }
        60% { opacity:1; transform: scale(0.98); filter: blur(0); }
        100% { transform: scale(1); opacity:1; }
    }
    @keyframes fadeOutDown {
        0% { opacity:1; transform: translateY(0) scale(1); }
        100% { opacity:0; transform: translateY(40px) scale(.98); }
    }
    @keyframes fadeOutUp {
        0% { opacity:1; transform: translateY(0) scale(1); }
        100% { opacity:0; transform: translateY(-40px) scale(.98); }
    }
    @keyframes slideLeftIn {
        0% { opacity:0; transform: translateX(-120%) rotate(-2deg); }
        60% { opacity:1; transform: translateX(8px) rotate(0deg); }
        100% { transform: translateX(0); }
    }
    @keyframes slideRightIn {
        0% { opacity:0; transform: translateX(120%) rotate(2deg); }
        60% { opacity:1; transform: translateX(-8px) rotate(0deg); }
        100% { transform: translateX(0); }
    }
    @keyframes popIn {
        0% { opacity:0; transform: scale(.2) rotate(6deg); }
        70% { opacity:1; transform: scale(1.12) rotate(-4deg); }
        100% { transform: scale(1) rotate(0); }
    }
    @keyframes rotateIn3d {
        0% { opacity:0; transform: perspective(800px) translateZ(-400px) rotateX(30deg); }
        60% { opacity:1; transform: perspective(800px) translateZ(20px) rotateX(0deg); }
        100% { transform: perspective(800px) translateZ(0) rotateX(0); }
    }
    @keyframes zoomPulse {
        0% { opacity:0; transform: scale(.6); }
        60% { opacity:1; transform: scale(1.06); }
        100% { transform: scale(1); }
    }
    @keyframes bounceIn {
        0% { opacity:0; transform: scale(0.3) translateY(100px); }
        50% { opacity:1; transform: scale(1.05) translateY(-10px); }
        70% { transform: scale(0.95) translateY(5px); }
        100% { opacity:1; transform: scale(1) translateY(0); }
    }
    @keyframes flipIn {
        0% { opacity:0; transform: perspective(400px) rotateX(90deg); }
        40% { opacity:1; transform: perspective(400px) rotateX(-10deg); }
        70% { transform: perspective(400px) rotateX(5deg); }
        100% { opacity:1; transform: perspective(400px) rotateX(0deg); }
    }
    @keyframes swingIn {
        0% { opacity:0; transform: rotate(-15deg) scale(0.8); }
        60% { opacity:1; transform: rotate(5deg) scale(1.02); }
        80% { transform: rotate(-2deg) scale(0.98); }
        100% { opacity:1; transform: rotate(0) scale(1); }
    }

    .char {
        display:inline-block;
        opacity:0;
        transform: translateY(8px) scale(.98);
    }
    @keyframes charIn {
        0%{ opacity:0; transform: translateY(10px) scale(.96); filter: blur(6px); }
        60%{ opacity:1; transform: translateY(-2px) scale(1.02); filter: blur(0); }
        100%{ transform: translateY(0) scale(1); opacity:1; }
    }

    .glitch {
        position:relative;
        color:var(--main-white);
    }
    .glitch::before, .glitch::after{
        content: attr(data-text);
        position:absolute;
        left:0; top:0;
        width:100%;
        opacity:0.7;
        clip-path: inset(0 0 0 0);
        pointer-events:none;
    }
    .glitch::before{ transform: translate3d(-6px,-2px,0); color:#ff3b3b; mix-blend-mode: screen; animation: glitchA .6s infinite linear; }
    .glitch::after{ transform: translate3d(6px,2px,0); color:#38f7ff; mix-blend-mode: screen; animation: glitchB .8s infinite linear; }
    @keyframes glitchA {
        0%{ clip-path: inset(0 0 80% 0); }
        20%{ clip-path: inset(10% 0 60% 0); transform: translate3d(-4px,-1px,0); }
        40%{ clip-path: inset(40% 0 10% 0); transform: translate3d(-6px,-3px,0); }
        60%{ clip-path: inset(20% 0 50% 0); transform: translate3d(-2px,0,0); }
        100%{ clip-path: inset(0 0 80% 0); transform: translate3d(-6px,-2px,0); }
    }
    @keyframes glitchB {
        0%{ clip-path: inset(80% 0 0 0); }
        30%{ clip-path: inset(60% 0 10% 0); transform: translate3d(6px,3px,0); }
        70%{ clip-path: inset(30% 0 30% 0); transform: translate3d(4px,1px,0); }
        100%{ clip-path: inset(80% 0 0 0); transform: translate3d(6px,2px,0); }
    }

    .particle {
        position:absolute;
        width:8px;
        height:8px;
        border-radius:50%;
        background: rgba(255,255,255,0.9);
        pointer-events:none;
        z-index:9;
        transform:translate(-50%,-50%) scale(.6);
        opacity:0;
    }

    .in-fadeZoom { animation: fadeZoomIn .85s cubic-bezier(.2,.9,.3,1) forwards; }
    .out-fade { animation: fadeOutDown .75s ease forwards; }
    .out-fade-up { animation: fadeOutUp .75s ease forwards; }
    .in-slideLeft { animation: slideLeftIn .82s cubic-bezier(.2,.9,.3,1) forwards; }
    .in-slideRight { animation: slideRightIn .82s cubic-bezier(.2,.9,.3,1) forwards; }
    .in-pop { animation: popIn .72s cubic-bezier(.3,.9,.25,1) forwards; }
    .in-rotate3d { animation: rotateIn3d .9s cubic-bezier(.25,.9,.28,1) forwards; }
    .in-zoomPulse { animation: zoomPulse .8s cubic-bezier(.2,.9,.3,1) forwards; }
    .in-bounce { animation: bounceIn .9s cubic-bezier(.2,.9,.3,1) forwards; }
    .in-flip { animation: flipIn 1s cubic-bezier(.25,.9,.28,1) forwards; }
    .in-swing { animation: swingIn .8s cubic-bezier(.2,.9,.3,1) forwards; }
    .char-animate { animation: charIn .56s cubic-bezier(.2,.9,.2,1) forwards; }

    @media (max-width:800px){
        #bottom-container {
            gap: 15px;
            padding: 0 15px;
        }
        #vinyl-container {
            width: 60px;
            height: 60px;
        }
        #now-playing-text {
            font-size: 14px;
            max-width: 200px;
        }
        #now-playing-artist {
            font-size: 12px;
        }
        #lyric-line{ font-size: clamp(20px, 7vw, 42px); }
        #lyric-wrapper {
            padding-bottom: 100px;
        }
    }

    @media (max-width:480px){
        #bottom-container {
            gap: 12px;
            padding: 0 12px;
        }
        #vinyl-container {
            width: 50px;
            height: 50px;
        }
        #now-playing-text {
            font-size: 13px;
            max-width: 180px;
        }
        #now-playing-artist {
            font-size: 11px;
        }
    }
</style>
</head>
<body>

<div id="blur-bg"></div>

<div id="lyric-wrapper">
    <div id="lyric-line" aria-live="polite"></div>
</div>

<div id="bottom-container">
    <div id="vinyl-container"><img id="albumImage" src="" alt="album cover"></div>
    <div id="now-playing-text">
        <div id="now-playing-track">Track</div>
        <div id="now-playing-artist">Artist</div>
    </div>
</div>

<script>
// ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ==========
const SYNC_CONFIG = {
    adjustment: 0, // —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
    usePreciseTiming: true,
    syncCheckInterval: 100, // —á–∞—â–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
    maxTimeDrift: 2 // –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥—Ä–µ–π—Ñ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
};

const client_id = "d97a877f3d4b4c6f977e4525ca4884d7";
const redirect_uri = "https://karmirshalyan.github.io/lyricviz/";
const scopes = ["user-read-currently-playing", "user-read-playback-state", "streaming"];

let token = null;
let currentAlbum = '';
let lyrics = [];
let playbackStartTime = 0;
let duration = 0;
let isPaused = false;
let lastTrackId = "";
let currentLyricIndex = -1;
let lastProgressMs = 0;
let lastApiResponseTime = 0;

// ========== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –í–†–ï–ú–ï–ù–ò ==========
function getCurrentPlaybackTime() {
    if (!playbackStartTime || isPaused) return lastProgressMs / 1000;
    
    const now = Date.now();
    const elapsed = (now - playbackStartTime) / 1000;
    return elapsed + SYNC_CONFIG.adjustment;
}

function resetPlaybackTime(progressMs) {
    playbackStartTime = Date.now() - progressMs;
    lastProgressMs = progressMs;
    lastApiResponseTime = Date.now();
}

// ========== –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–ê–†–°–ò–ù–ì LRC ==========
function parseLRC(lrc) {
    const lines = lrc.split(/\r?\n/);
    const out = [];
    
    for (let raw of lines) {
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏: [mm:ss.xx] –∏–ª–∏ [mm:ss:xx]
        const timeMatch = raw.match(/\[(\d{2}):(\d{2})[\.:](\d{2})]/);
        if (!timeMatch) continue;
        
        const minutes = parseInt(timeMatch[1]);
        const seconds = parseInt(timeMatch[2]);
        const hundredths = parseInt(timeMatch[3]);
        const time = minutes * 60 + seconds + hundredths / 100;
        
        const text = raw.replace(/\[.*?\]/g, '').trim();
        if (text) {
            out.push({ time, text });
        }
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ª—É—á—à–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    out.sort((a, b) => a.time - b.time);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è
    out.forEach(line => {
        line.displayTime = line.time - 0.3; // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞ 300ms –¥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    });
    
    return out;
}

// ========== –ü–û–õ–£–ß–ï–ù–ò–ï –¢–ï–ö–°–¢–û–í –ü–ï–°–ï–ù ==========
function fetchLyrics(track, artist, album, durationSec){
    const url = `https://lrclib.net/api/get?track_name=${encodeURIComponent(track)}&artist_name=${encodeURIComponent(artist)}&album_name=${encodeURIComponent(album)}&duration=${durationSec}`;
    
    fetch(url)
        .then(r => r.json())
        .then(data => {
            if (!data.syncedLyrics) {
                console.log("–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω");
                lyrics = [];
                clearDisplayedLyric();
                return;
            }
            
            lyrics = parseLRC(data.syncedLyrics);
            currentLyricIndex = -1;
            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${lyrics.length} —Å—Ç—Ä–æ–∫ —Ç–µ–∫—Å—Ç–∞`);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
            if (lyrics.length > 0 && lyrics[0].time > 5) {
                SYNC_CONFIG.adjustment = -lyrics[0].time + 2;
                console.log(`–ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${SYNC_CONFIG.adjustment.toFixed(2)}s`);
            }
        })
        .catch(e => {
            console.log("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç–∞:", e);
            lyrics = [];
            clearDisplayedLyric();
        });
}

// ========== –ê–ù–ò–ú–ê–¶–ò–ò –¢–ï–ö–°–¢–ê ==========
const lyricEl = document.getElementById('lyric-line');
const EFFECTS = [
    'fadeZoom', 'slideLeft', 'slideRight', 'pop', 'typewriter', 
    'glitch', 'rotate3d', 'zoomPulse', 'bounce', 'flip', 'swing', 'particle'
];

function clearDisplayedLyric() {
    lyricEl.innerHTML = "";
    lyricEl.style.opacity = 0;
    currentLyricIndex = -1;
}

function clearParticles() {
    document.querySelectorAll('.particle').forEach(p => p.remove());
}

function createParticleBurst(cx, cy, color='rgba(255,255,255,0.95)', count=22) {
    clearParticles();
    for (let i=0;i<count;i++){
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = cx + 'px';
        p.style.top = cy + 'px';
        p.style.background = color;
        const angle = Math.random() * Math.PI * 2;
        const dist = 60 + Math.random()*140;
        const dx = Math.cos(angle) * dist;
        const dy = Math.sin(angle) * dist;
        p.style.transition = `transform ${0.85 + Math.random()*0.45}s cubic-bezier(.2,.9,.25,1), opacity .7s linear`;
        document.body.appendChild(p);
        requestAnimationFrame(() => {
            p.style.opacity = 1;
            p.style.transform = `translate(${dx}px, ${dy}px) scale(${0.6 + Math.random()})`;
        });
        setTimeout(()=>{ p.style.opacity = 0; }, 650 + Math.random()*350);
        setTimeout(()=> p.remove(), 1400 + Math.random()*300);
    }
}

function showLyricLine(objLine) {
    if (!objLine || !objLine.text) {
        lyricEl.innerHTML = "";
        lyricEl.style.opacity = 0;
        return;
    }
    
    const text = objLine.text;
    lyricEl.className = "";
    lyricEl.style.opacity = 0;
    lyricEl.style.transform = "";
    lyricEl.innerHTML = "";
    clearParticles();

    const effect = EFFECTS[Math.floor(Math.random() * EFFECTS.length)];
    const visibleDuration = 3500;

    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log(`–ü–æ–∫–∞–∑: "${text}" (—ç—Ñ—Ñ–µ–∫—Ç: ${effect})`);

    if (effect === 'typewriter') {
        const chars = Array.from(text);
        lyricEl.style.opacity = 1;
        lyricEl.style.whiteSpace = 'nowrap';
        chars.forEach((ch, i) => {
            const span = document.createElement('span');
            span.className = 'char';
            span.textContent = ch;
            span.style.animationDelay = (i * 28) + 'ms';
            span.classList.add('char-animate');
            lyricEl.appendChild(span);
        });
        setTimeout(()=> {
            lyricEl.classList.add('in-zoomPulse');
        }, 10);
        scheduleAutoClear(visibleDuration + text.length * 28 + 400);
        return;
    }

    if (effect === 'glitch') {
        lyricEl.setAttribute('data-text', text);
        lyricEl.classList.add('glitch');
        lyricEl.textContent = text;
        lyricEl.classList.add('in-fadeZoom');
        scheduleAutoClear(visibleDuration);
        return;
    }

    if (effect === 'particle') {
        lyricEl.textContent = text;
        lyricEl.classList.add('in-pop');
        const cx = window.innerWidth/2 + (Math.random()-0.5)*40;
        const cy = window.innerHeight/2;
        setTimeout(()=> createParticleBurst(cx, cy, 'rgba(255,255,255,0.95)', 22), 80);
        scheduleAutoClear(visibleDuration);
        return;
    }

    lyricEl.textContent = text;
    
    switch(effect){
        case 'fadeZoom': lyricEl.classList.add('in-fadeZoom'); break;
        case 'slideLeft': lyricEl.classList.add('in-slideLeft'); break;
        case 'slideRight': lyricEl.classList.add('in-slideRight'); break;
        case 'pop': lyricEl.classList.add('in-pop'); break;
        case 'rotate3d': lyricEl.classList.add('in-rotate3d'); break;
        case 'zoomPulse': lyricEl.classList.add('in-zoomPulse'); break;
        case 'bounce': lyricEl.classList.add('in-bounce'); break;
        case 'flip': lyricEl.classList.add('in-flip'); break;
        case 'swing': lyricEl.classList.add('in-swing'); break;
        default: lyricEl.classList.add('in-fadeZoom');
    }
    
    scheduleAutoClear(visibleDuration);
}

let autoClearTimeout = null;
function scheduleAutoClear(ms) {
    if (autoClearTimeout) clearTimeout(autoClearTimeout);
    autoClearTimeout = setTimeout(()=> {
        lyricEl.classList.remove('in-fadeZoom','in-slideLeft','in-slideRight','in-pop','in-rotate3d','in-zoomPulse','in-bounce','in-flip','in-swing','char-animate');
        const exitEffect = Math.random() > 0.5 ? 'out-fade' : 'out-fade-up';
        lyricEl.classList.add(exitEffect);
        setTimeout(()=> {
            lyricEl.innerHTML = '';
            lyricEl.className = '';
            clearParticles();
        }, 750);
    }, ms);
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ï–ö–°–¢–ê –° –£–õ–£–ß–®–ï–ù–ù–û–ô –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ï–ô ==========
function updateLyrics() {
    if (!lyrics || !lyrics.length) return;
    
    const currentTime = getCurrentPlaybackTime();
    
    // –ò—â–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    let idx = -1;
    for (let i = 0; i < lyrics.length; i++) {
        const line = lyrics[i];
        const displayTime = line.displayTime !== undefined ? line.displayTime : line.time;
        
        if (currentTime >= displayTime && 
            (i === lyrics.length - 1 || currentTime < (lyrics[i + 1].displayTime || lyrics[i + 1].time))) {
            idx = i;
            break;
        }
    }
    
    if (idx === -1 && currentTime < (lyrics[0]?.displayTime || lyrics[0]?.time || Infinity)) {
        // –î–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ - –æ—á–∏—â–∞–µ–º
        if (currentLyricIndex !== -1) {
            clearDisplayedLyric();
        }
        return;
    }
    
    if (idx !== currentLyricIndex && idx >= 0) {
        currentLyricIndex = idx;
        const line = lyrics[idx];
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        const expectedTime = line.displayTime || line.time;
        const timeDiff = (currentTime - expectedTime).toFixed(2);
        console.log(`–°—Ç—Ä–æ–∫–∞ ${idx + 1}/${lyrics.length}: "${line.text}" | –í—Ä–µ–º—è: ${currentTime.toFixed(2)}s (–æ–∂–∏–¥–∞–ª–æ—Å—å: ${expectedTime.toFixed(2)}s, —Ä–∞–∑–Ω–∏—Ü–∞: ${timeDiff}s)`);
        
        showLyricLine(line);
    }
}

// ========== SPOTIFY API ==========
async function initPlayer() {
    token = await getValidToken();
    setInterval(() => fetchSong(token), 2000); // –†–µ–∂–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    setInterval(updateLyrics, SYNC_CONFIG.syncCheckInterval);
}

function fetchSong(token) {
    fetch('https://api.spotify.com/v1/me/player/currently-playing', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => {
        if (res.status === 204) return null;
        return res.json();
    })
    .then(data => {
        if(!data || !data.item) {
            clearLyricsAndVisual();
            lastTrackId = "";
            return;
        }
        
        const track = data.item;
        const progressMs = data.progress_ms || 0;

        if (track.id !== lastTrackId) {
            lastTrackId = track.id;
            lyrics = [];
            currentLyricIndex = -1;
            
            document.getElementById('now-playing-track').textContent = track.name;
            document.getElementById('now-playing-artist').textContent = track.artists.map(a=>a.name).join(', ');
            
            console.log(`–ù–æ–≤—ã–π —Ç—Ä–µ–∫: "${track.name}" - ${track.artists[0].name}`);
            fetchLyrics(track.name, track.artists[0].name, track.album.name, track.duration_ms/1000);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–∫–∞
            resetPlaybackTime(progressMs);
        } else {
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ –¥—Ä–µ–π—Ñ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
            const expectedProgress = (Date.now() - playbackStartTime);
            const actualProgress = progressMs;
            const drift = Math.abs(expectedProgress - actualProgress);
            
            if (drift > SYNC_CONFIG.maxTimeDrift * 1000) {
                console.log(`–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏: –¥—Ä–µ–π—Ñ ${(drift/1000).toFixed(2)}s`);
                resetPlaybackTime(progressMs);
            }
        }

        duration = track.duration_ms / 1000;
        lastProgressMs = progressMs;
        isPaused = !data.is_playing;

        const cover = track.album.images && track.album.images[0] && track.album.images[0].url;
        if (cover && cover !== currentAlbum) {
            currentAlbum = cover;
            const albumImg = document.getElementById('albumImage');
            albumImg.style.opacity = 0;
            setTimeout(()=> {
                albumImg.src = cover;
                albumImg.style.opacity = 1;
                document.getElementById('blur-bg').style.backgroundImage = `url(${cover})`;
            }, 260);
        }

        updateRotation();
    })
    .catch(e => {
        console.log("–û—à–∏–±–∫–∞ Spotify API:", e);
    });
}

function clearLyricsAndVisual() {
    lyrics = [];
    currentLyricIndex = -1;
    clearDisplayedLyric();
}

function updateRotation() {
    const vinyl = document.getElementById('vinyl-container');
    if(!isPaused){
        vinyl.classList.add('spinning');
        vinyl.classList.remove('paused');
    } else {
        vinyl.classList.add('paused');
    }
}

// ========== –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –û–¢–õ–ê–î–ö–ò ==========
// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Å–æ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
window.syncAdjust = function(seconds) {
    SYNC_CONFIG.adjustment = seconds;
    console.log(`–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞: ${seconds}s`);
};

window.showSyncInfo = function() {
    console.log('=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===');
    console.log(`–¢–µ–∫—É—â–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞: ${SYNC_CONFIG.adjustment}s`);
    console.log(`–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${getCurrentPlaybackTime().toFixed(2)}s`);
    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç—Ä–æ–∫: ${lyrics.length}`);
    console.log(`–¢–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å: ${currentLyricIndex}`);
    if (lyrics.length > 0 && currentLyricIndex >= 0) {
        console.log(`–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–æ–∫–∞: "${lyrics[currentLyricIndex].text}"`);
    }
};

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.adjustSync = function(sec) {
    SYNC_CONFIG.adjustment += sec;
    console.log(`–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${SYNC_CONFIG.adjustment.toFixed(2)}s`);
    return SYNC_CONFIG.adjustment;
};

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
async function getValidToken() {
    let tok = localStorage.getItem("access_token");
    const refresh_token = localStorage.getItem("refresh_token");
    if (!tok) return handleAuth();

    const test = await fetch("https://api.spotify.com/v1/me", {
        headers: { Authorization: "Bearer " + tok }
    });

    if (test.status === 401 && refresh_token) {
        const newTok = await refreshToken(refresh_token);
        localStorage.setItem("access_token", newTok.access_token);
        if (newTok.refresh_token) localStorage.setItem("refresh_token", newTok.refresh_token);
        return newTok.access_token;
    }
    return tok;
}

async function handleAuth() {
    const params = new URLSearchParams(window.location.search);
    if (params.get("code")) {
        const tokenData = await requestAccessToken(params.get("code"));
        localStorage.setItem("access_token", tokenData.access_token);
        localStorage.setItem("refresh_token", tokenData.refresh_token);
        window.history.replaceState({}, document.title, redirect_uri);
        return tokenData.access_token;
    }
    const stored = localStorage.getItem("access_token");
    if (stored) return stored;
    startAuth();
}

async function startAuth() {
    const codeVerifier = generateRandomString(64);
    saveVerifier(codeVerifier);
    const codeChallenge = await sha256(codeVerifier);
    const authUrl =
        "https://accounts.spotify.com/authorize" +
        `?client_id=${client_id}` +
        `&response_type=code` +
        `&redirect_uri=${encodeURIComponent(redirect_uri)}` +
        `&scope=${encodeURIComponent(scopes.join(" "))}` +
        `&code_challenge_method=S256` +
        `&code_challenge=${codeChallenge}`;
    window.location = authUrl;
}

async function requestAccessToken(code) {
    const verifier = loadVerifier();
    const body = new URLSearchParams({
        client_id,
        grant_type: "authorization_code",
        code,
        redirect_uri,
        code_verifier: verifier
    });
    const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
    });
    return await res.json();
}

async function refreshToken(refresh_token) {
    const body = new URLSearchParams({ client_id, grant_type: "refresh_token", refresh_token });
    const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
    });
    return await res.json();
}

function generateRandomString(length) {
    let text = "";
    const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    for (let i = 0; i < length; i++) text += possible.charAt(Math.floor(Math.random() * possible.length));
    return text;
}

async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    const hash = await crypto.subtle.digest("SHA-256", data);
    return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

function saveVerifier(v) { localStorage.setItem("code_verifier", v); }
function loadVerifier() { return localStorage.getItem("code_verifier"); }

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
initPlayer();

window.addEventListener('resize', () => clearParticles());
window.addEventListener('beforeunload', () => {
    if (autoClearTimeout) clearTimeout(autoClearTimeout);
});

console.log("üéµ Lyric Visualizer –∑–∞–≥—Ä—É–∂–µ–Ω!");
console.log("üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ adjustSync(seconds) –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏");
console.log("üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ showSyncInfo() –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏");
</script>
</body>
</html>
